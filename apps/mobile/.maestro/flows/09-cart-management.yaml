# =============================================================================
# FLOW 09: Gestion du panier (modification/suppression)
# =============================================================================
# Teste la modification des quantites et suppression d'articles
# Tags: cart, e2e
# Prerequis: Panier avec articles
# =============================================================================

appId: com.oneeats.mobile
name: "09 - Cart Management"
tags:
  - cart
  - e2e
  - regression

---

# -----------------------------------------------------------------------------
# SETUP: Creer un panier avec articles
# -----------------------------------------------------------------------------
- launchApp:
    clearState: true

- extendedWaitUntil:
    visible:
      anyOf:
        - text: "Continuer sans compte"
        - text: "Restaurants"
    timeout: 15000

- runFlow:
    when:
      visible: "Continuer sans compte"
    commands:
      - tapOn: "Continuer sans compte"

# Ouvrir un restaurant et ajouter des articles
- extendedWaitUntil:
    visible: "Restaurants"
    timeout: 15000

- scroll:
    direction: DOWN

- tapOn:
    anyOf:
      - id: "restaurant-card-0"
      - text: "‚≠ê"
    index: 0

- extendedWaitUntil:
    visible:
      anyOf:
        - text: "‚Ç¨"
        - text: "Menu"
    timeout: 15000

- scroll:
    direction: DOWN

# Ajouter 2 articles
- tapOn:
    anyOf:
      - text: "Ajouter"
      - text: "+"
    index: 0

- tapOn:
    anyOf:
      - text: "Ajouter"
      - text: "+"
    index: 1

# Aller au panier
- tapOn:
    text: "Panier"

- extendedWaitUntil:
    visible: "Votre Panier"
    timeout: 5000

- takeScreenshot: "09-cart-initial"

# -----------------------------------------------------------------------------
# TEST 1: Augmenter la quantite d'un article
# -----------------------------------------------------------------------------
- tapOn:
    anyOf:
      - text: "+"
      - id: "quantity-increase"
    index: 0

# Verifier la mise a jour
- extendedWaitUntil:
    visible:
      anyOf:
        - text: "2"
        - text: "Total"
    timeout: 3000

- takeScreenshot: "09-quantity-increased"

# -----------------------------------------------------------------------------
# TEST 2: Diminuer la quantite
# -----------------------------------------------------------------------------
- tapOn:
    anyOf:
      - text: "-"
      - id: "quantity-decrease"
    index: 0

- extendedWaitUntil:
    visible:
      anyOf:
        - text: "1"
        - text: "Total"
    timeout: 3000

- takeScreenshot: "09-quantity-decreased"

# -----------------------------------------------------------------------------
# TEST 3: Supprimer un article (quantite a 0 ou icone suppression)
# -----------------------------------------------------------------------------
# Chercher l'icone de suppression
- tapOn:
    anyOf:
      - id: "delete-item"
      - text: "üóë"
      - id: "remove-item"
    index: 0

# Confirmer la suppression si dialog
- runFlow:
    when:
      visible: "Supprimer"
    commands:
      - tapOn: "Supprimer"

- takeScreenshot: "09-item-removed"

# -----------------------------------------------------------------------------
# TEST 4: Verifier la mise a jour du total
# -----------------------------------------------------------------------------
- assertVisible:
    text: "‚Ç¨"

# Verifier que le total a change
- assertVisible:
    anyOf:
      - text: "Total"
      - text: "Sous-total"

# -----------------------------------------------------------------------------
# TEST 5: Bouton "Ajouter plus" pour retourner au restaurant
# -----------------------------------------------------------------------------
- assertVisible:
    anyOf:
      - text: "Ajouter"
      - text: "+ Ajouter"

- tapOn:
    anyOf:
      - text: "Ajouter"
      - text: "+ Ajouter"
    index: 0

# Verifier qu'on retourne au restaurant
- extendedWaitUntil:
    visible:
      anyOf:
        - text: "Menu"
        - text: "‚Ç¨"
    timeout: 5000

- takeScreenshot: "09-back-to-restaurant"

# Retour au panier
- tapOn:
    text: "Panier"

- extendedWaitUntil:
    visible: "Votre Panier"
    timeout: 5000

# -----------------------------------------------------------------------------
# TEST 6: Vider completement le panier
# -----------------------------------------------------------------------------
# Supprimer tous les articles restants
- runFlow:
    when:
      visible:
        anyOf:
          - id: "delete-item"
          - text: "üóë"
    commands:
      - repeat:
          times: 5
          commands:
            - runFlow:
                when:
                  visible:
                    anyOf:
                      - id: "delete-item"
                      - text: "üóë"
                commands:
                  - tapOn:
                      anyOf:
                        - id: "delete-item"
                        - text: "üóë"
                      index: 0
                  - runFlow:
                      when:
                        visible: "Supprimer"
                      commands:
                        - tapOn: "Supprimer"

# -----------------------------------------------------------------------------
# TEST 7: Verifier l'etat panier vide
# -----------------------------------------------------------------------------
- extendedWaitUntil:
    visible:
      anyOf:
        - text: "panier est vide"
        - text: "Votre panier est vide"
        - text: "D√©couvrir les restaurants"
    timeout: 5000

- takeScreenshot: "09-cart-empty"

# -----------------------------------------------------------------------------
# TEST 8: Bouton "Decouvrir" pour retourner a l'accueil
# -----------------------------------------------------------------------------
- tapOn:
    anyOf:
      - text: "D√©couvrir les restaurants"
      - text: "D√©couvrir"
      - text: "Parcourir"

- extendedWaitUntil:
    visible:
      anyOf:
        - text: "Restaurants"
        - text: "Cat√©gories"
    timeout: 5000

- takeScreenshot: "09-back-to-home"
