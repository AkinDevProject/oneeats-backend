# =============================================================================
# FLOW 10: Passage de commande (Checkout)
# =============================================================================
# Teste le flow complet de commande: formulaire, validation, confirmation
# Tags: order, e2e, smoke, critical
# Prerequis: Utilisateur connecte, panier avec articles
# =============================================================================

appId: com.oneeats.mobile
name: "10 - Complete Checkout Flow"
tags:
  - order
  - e2e
  - smoke
  - critical

---

# -----------------------------------------------------------------------------
# SETUP: Connexion et creation du panier
# -----------------------------------------------------------------------------
- launchApp:
    clearState: true

# Skip ou login
- extendedWaitUntil:
    visible:
      anyOf:
        - text: "Se connecter"
        - text: "Restaurants"
    timeout: 15000

# Tenter la connexion (ou mode mock)
- runFlow:
    when:
      visible: "Se connecter"
    commands:
      - tapOn: "Se connecter"
      - extendedWaitUntil:
          visible:
            anyOf:
              - text: "Restaurants"
              - text: "Username"
          timeout: 15000
      # Si Keycloak, login
      - runFlow:
          when:
            visible: "Username"
          commands:
            - tapOn:
                anyOf:
                  - id: "username"
                  - text: "Username"
            - inputText: ${TEST_USER_EMAIL}
            - tapOn:
                anyOf:
                  - id: "password"
                  - text: "Password"
            - inputText: ${TEST_USER_PASSWORD}
            - tapOn:
                anyOf:
                  - text: "Sign In"
                  - id: "kc-login"
            - extendedWaitUntil:
                visible: "Restaurants"
                timeout: 15000

- extendedWaitUntil:
    visible: "Restaurants"
    timeout: 15000

# Ouvrir restaurant et ajouter article
- scroll:
    direction: DOWN

- tapOn:
    anyOf:
      - id: "restaurant-card-0"
      - text: "⭐"
    index: 0

- extendedWaitUntil:
    visible:
      anyOf:
        - text: "€"
        - text: "Menu"
    timeout: 15000

- scroll:
    direction: DOWN

- tapOn:
    anyOf:
      - text: "Ajouter"
      - text: "+"
    index: 0

# Aller au panier
- tapOn:
    text: "Panier"

- extendedWaitUntil:
    visible: "Votre Panier"
    timeout: 5000

- takeScreenshot: "10-checkout-cart-ready"

# -----------------------------------------------------------------------------
# TEST 1: Verifier le formulaire de commande
# -----------------------------------------------------------------------------
- scroll:
    direction: DOWN

# Section heure de retrait
- assertVisible:
    anyOf:
      - text: "Heure de retrait"
      - text: "Retrait"

# Options de creneaux horaires
- assertVisible:
    anyOf:
      - text: "h"
      - text: ":"

- takeScreenshot: "10-pickup-time-slots"

# -----------------------------------------------------------------------------
# TEST 2: Selectionner une heure de retrait
# -----------------------------------------------------------------------------
- tapOn:
    anyOf:
      - text: "h"
    index: 2

- takeScreenshot: "10-time-selected"

# -----------------------------------------------------------------------------
# TEST 3: Section informations client
# -----------------------------------------------------------------------------
- scroll:
    direction: DOWN

- assertVisible:
    anyOf:
      - text: "Vos informations"
      - text: "Informations"

# Champs du formulaire
- assertVisible:
    anyOf:
      - text: "Nom"
      - text: "Nom complet"

- assertVisible:
    anyOf:
      - text: "Téléphone"
      - text: "Numéro"

- takeScreenshot: "10-customer-form"

# -----------------------------------------------------------------------------
# TEST 4: Remplir le formulaire client
# -----------------------------------------------------------------------------
# Nom
- tapOn:
    anyOf:
      - text: "Nom complet"
      - text: "Nom"
      - id: "customer-name"

- clearText

- inputText: ${TEST_USER_NAME}

# Telephone
- tapOn:
    anyOf:
      - text: "Numéro de téléphone"
      - text: "Téléphone"
      - id: "customer-phone"

- clearText

- inputText: ${TEST_USER_PHONE}

- hideKeyboard

- takeScreenshot: "10-form-filled"

# -----------------------------------------------------------------------------
# TEST 5: Instructions speciales (optionnel)
# -----------------------------------------------------------------------------
- scroll:
    direction: DOWN

- runFlow:
    when:
      visible:
        anyOf:
          - text: "Instructions"
          - text: "optionnel"
    commands:
      - tapOn:
          anyOf:
            - text: "Instructions"
            - text: "optionnel"
      - inputText: "Sans oignons svp"
      - hideKeyboard

- takeScreenshot: "10-instructions-added"

# -----------------------------------------------------------------------------
# TEST 6: Verifier le recapitulatif de commande
# -----------------------------------------------------------------------------
- scroll:
    direction: DOWN

- assertVisible:
    anyOf:
      - text: "Total"
      - text: "Sous-total"

- assertVisible:
    text: "€"

# Bouton commander
- assertVisible:
    anyOf:
      - text: "Commander"
      - text: "Valider"
      - text: "Confirmer"

- takeScreenshot: "10-order-summary"

# -----------------------------------------------------------------------------
# TEST 7: Valider la commande
# -----------------------------------------------------------------------------
- tapOn:
    anyOf:
      - text: "Commander"
      - text: "Valider"
      - text: "Confirmer"

# Attendre la reponse
- extendedWaitUntil:
    visible:
      anyOf:
        # Succes
        - text: "Commande confirmée"
        - text: "confirmée"
        - text: "En attente"
        - text: "En préparation"
        # Ou erreur
        - text: "Erreur"
        - text: "Connexion requise"
    timeout: 15000

- takeScreenshot: "10-order-result"

# -----------------------------------------------------------------------------
# TEST 8: Verifier la confirmation (si succes)
# -----------------------------------------------------------------------------
- runFlow:
    when:
      visible:
        anyOf:
          - text: "confirmée"
          - text: "En attente"
          - text: "En préparation"
    commands:
      # Verifier les details de la commande
      - assertVisible:
          anyOf:
            - text: "Commande"
            - text: "#"

      # Verifier le statut
      - assertVisible:
          anyOf:
            - text: "En attente"
            - text: "Confirmée"
            - text: "En préparation"

      - takeScreenshot: "10-order-confirmed"

# -----------------------------------------------------------------------------
# TEST 9: Si erreur connexion, verifier le message
# -----------------------------------------------------------------------------
- runFlow:
    when:
      visible: "Connexion requise"
    commands:
      - assertVisible: "connecté"
      - takeScreenshot: "10-auth-required"
