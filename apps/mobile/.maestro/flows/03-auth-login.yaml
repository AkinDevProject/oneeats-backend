# =============================================================================
# FLOW 03: Authentification - Connexion
# =============================================================================
# Teste le flow complet de connexion utilisateur via Keycloak SSO
# Tags: smoke, auth, e2e
# Prerequis: Backend et Keycloak accessibles
# =============================================================================

appId: com.oneeats.mobile
name: "03 - Authentication Login Flow"
tags:
  - smoke
  - auth
  - e2e

---

# -----------------------------------------------------------------------------
# SETUP: Lancement avec etat neuf (deconnecte)
# -----------------------------------------------------------------------------
- launchApp:
    clearState: true
    clearKeychain: true

# -----------------------------------------------------------------------------
# STEP 1: Arriver sur l'ecran de connexion
# -----------------------------------------------------------------------------
- extendedWaitUntil:
    visible: ".*"
    timeout: 15000

# -----------------------------------------------------------------------------
# STEP 2: Verifier la page de connexion
# -----------------------------------------------------------------------------
- assertVisible: "OneEats"

# Verifier la presence du bouton principal
- assertVisible: "Se connecter"

- takeScreenshot: "03-login-screen"

# -----------------------------------------------------------------------------
# STEP 3: Verifier les options de connexion sociale
# -----------------------------------------------------------------------------
- assertVisible: "Google"

- assertVisible: "Apple"

# -----------------------------------------------------------------------------
# STEP 4: Verifier l'option "Continuer sans compte"
# -----------------------------------------------------------------------------
- assertVisible: "Continuer sans compte"

# -----------------------------------------------------------------------------
# STEP 5: Tester la connexion principale (SSO Keycloak)
# -----------------------------------------------------------------------------
- tapOn: "Se connecter"

# Attendre la redirection vers Keycloak ou le resultat
- extendedWaitUntil:
    visible: "Sign in"
    timeout: 20000
    optional: true

- takeScreenshot: "03-keycloak-page"

# -----------------------------------------------------------------------------
# STEP 6: Entrer les credentials dans Keycloak
# -----------------------------------------------------------------------------
- runFlow:
    when:
      visible: "Username"
    commands:
      - tapOn: "Username or email"
      - inputText: ${TEST_USER_EMAIL}
      - tapOn: "Password"
      - inputText: ${TEST_USER_PASSWORD}
      - tapOn: "Sign In"
      - takeScreenshot: "03-keycloak-submitted"

# -----------------------------------------------------------------------------
# STEP 7: Verifier le succes de connexion
# -----------------------------------------------------------------------------
- extendedWaitUntil:
    visible: ".*proximit.*"
    timeout: 15000
    optional: true

- takeScreenshot: "03-login-success"

# -----------------------------------------------------------------------------
# STEP 8: Verifier que l'utilisateur est connecte (compte)
# -----------------------------------------------------------------------------
- tapOn:
    text: "Compte"
    optional: true

- extendedWaitUntil:
    visible: "Compte"
    timeout: 5000
    optional: true

- takeScreenshot: "03-compte-logged-in"
