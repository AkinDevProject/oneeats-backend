quarkus:
  application:
    name: OneEats Backend
    version: 1.0.0-SNAPSHOT

  # Serveur HTTP
  http:
    port: 8080
    host: 0.0.0.0  # Écouter sur toutes les interfaces pour permettre les connexions mobiles
    cors:
      ~: true
      origins:
        - http://localhost:3000
        - http://localhost:5173
        - http://localhost:8081
        - http://192.168.1.111:8080  # IP réseau pour appareils physiques
        - http://10.0.2.2:8080       # Android émulateur
      methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
      headers: accept,authorization,content-type,x-requested-with
      access-control-max-age: 86400
    # Routes protégées (auth)
    auth:
      permission:
        # Pages web protégées
        restaurant-pages:
          paths: /restaurant/*
          policy: authenticated
        admin-pages:
          paths: /admin/*
          policy: authenticated
        # API publiques (lecture seule pour mobile)
        api-public-read:
          paths: /api/restaurants,/api/restaurants/*,/api/menus,/api/menus/*,/api/menu-items,/api/menu-items/*
          policy: permit
          methods: GET
        # API protégées (écriture et utilisateurs)
        api-protected:
          paths: /api/*
          policy: authenticated
        # Routes publiques
        public-pages:
          paths: /login,/,/callback,/assets/*,/index.html
          policy: permit
        # Endpoints système publics
        system-endpoints:
          paths: /q/*,/health*,/metrics*,/openapi*
          policy: permit

  # Base de données
  datasource:
    db-kind: postgresql
    username: ${DB_USER:oneeats_user}
    password: ${DB_PASSWORD:oneeats_password}
    jdbc:
      url: ${DB_URL:jdbc:postgresql://localhost:5432/oneeats_dev}
      max-size: 20
      min-size: 2

  hibernate-orm:
    database:
      generation: update
    log:
      sql: false
    metrics:
      enabled: true

  # Sérialisation Jackson
  jackson:
    serialization-inclusion: non-null
    fail-on-unknown-properties: false
    write-dates-as-timestamps: false
    write-durations-as-timestamps: false

  # Logs
  log:
    level: INFO
    category:
      com.oneeats:
        level: DEBUG
    console:
      enable: true
      format: "%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n"

  # Santé et métriques
  smallrye-health:
    ui:
      enable: true

  micrometer:
    export:
      prometheus:
        enabled: true
        path: /metrics

  # DevUI Configuration (fix startup issue)
  dev-ui:
    cors:
      enabled: true

  # Sécurité OIDC/Keycloak
  oidc:
    # Tenant par défaut: Web (cookies/session)
    # URL du serveur Keycloak (port 8580 en dev - 8180 bloque par Hyper-V)
    # Utiliser l'IP réseau pour permettre l'accès depuis mobile
    auth-server-url: ${KEYCLOAK_URL:http://192.168.1.111:8580}/realms/oneeats
    client-id: ${KEYCLOAK_CLIENT_ID:oneeats-web}
    credentials:
      secret: ${KEYCLOAK_CLIENT_SECRET:oneeats-web-secret-dev}
    # Mode web-app: Quarkus gère les sessions avec cookies sécurisés
    application-type: web-app
    # Configuration TLS
    tls:
      verification: none  # Uniquement pour le développement
    # Mapping des rôles depuis Keycloak (dans l'access token)
    roles:
      source: accesstoken
      role-claim-path: realm_access/roles
    # Configuration des tokens et session
    token:
      issuer: any  # Accepter l'issuer du token (dev)
    authentication:
      # Redirection après login réussi vers callback qui gère la logique de rôle
      redirect-path: /callback
    # Logout configuration
    logout:
      path: /api/auth/logout
      post-logout-path: /login

    # Tenant mobile: Bearer token (JWT)
    mobile:
      auth-server-url: ${KEYCLOAK_URL:http://192.168.1.111:8580}/realms/oneeats
      client-id: oneeats-mobile
      # Mode service: validation Bearer token uniquement (pas de session)
      application-type: service
      tls:
        verification: none
      # Mapping des rôles depuis l'access token
      roles:
        source: accesstoken
        role-claim-path: realm_access/roles
      token:
        issuer: any

  # Frontend intégration (Quinoa) - Production
  quinoa:
    enabled: true  # Désactivé par défaut, activé en dev/prod
    package-manager: npm
    package-manager-install: false
    build-dir: dist
    ui-dir: apps/web

    # SPA routing pour production
    spa-routing: true
    spa-routing-path: "/"
    spa-routing-ignored-paths: "/api/*,/q/*,/health*,/metrics*,/openapi*,/ws/*"

# Configuration métier OneEats
oneeats:
  business:
    order:
      max-items-per-order: 50
      default-preparation-time-minutes: 20
      max-preparation-time-minutes: 120
      pickup-reminder-minutes: 5
    restaurant:
      max-distance-km: 50
      default-rating: 0.0
    notification:
      enabled: true
      email-enabled: false  # Désactivé en dev
      sms-enabled: false    # Désactivé en dev

  # Limites et sécurité
  api:
    rate-limit:
      enabled: false  # À activer en production
      requests-per-minute: 60
    pagination:
      default-page-size: 20
      max-page-size: 100
